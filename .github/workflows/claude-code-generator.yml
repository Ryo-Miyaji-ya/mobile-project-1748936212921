name: Claude Code Generator

on:
  workflow_dispatch:
    inputs:
      project_type:
        description: 'Project type (webapp, api, mobile, cli, library, bot)'
        required: true
        type: string
      tech_stack:
        description: 'Technology stack'
        required: true
        type: string
      requirements:
        description: 'Project requirements'
        required: true
        type: string
      slack_channel:
        description: 'Slack channel for notifications'
        required: true
        type: string
      slack_user:
        description: 'Slack user who requested'
        required: true
        type: string

jobs:
  generate-project:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          pip install requests

      - name: Generate project with Claude
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          cat > generate_project.py << 'EOF'
          import os
          import json
          import requests
          
          project_type = "${{ github.event.inputs.project_type }}"
          tech_stack = "${{ github.event.inputs.tech_stack }}"
          requirements = "${{ github.event.inputs.requirements }}"
          
          headers = {
              "x-api-key": os.environ["ANTHROPIC_API_KEY"],
              "content-type": "application/json",
              "anthropic-version": "2023-06-01"
          }
          
          prompt = f"""
æ–°ã—ã„{project_type}ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚

ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæƒ…å ±:
- ã‚¿ã‚¤ãƒ—: {project_type}
- æŠ€è¡“ã‚¹ã‚¿ãƒƒã‚¯: {tech_stack}
- è¦ä»¶: {requirements}

ä»¥ä¸‹ã‚’å®Ÿè£…ã—ã¦ãã ã•ã„:
1. é©åˆ‡ãªãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ§‹é€ 
2. åŸºæœ¬çš„ãªè¨­å®šãƒ•ã‚¡ã‚¤ãƒ«
3. ã‚¨ãƒ³ãƒˆãƒªãƒ¼ãƒã‚¤ãƒ³ãƒˆã¨ã‚µãƒ³ãƒ—ãƒ«ã‚³ãƒ¼ãƒ‰
4. README.mdãƒ•ã‚¡ã‚¤ãƒ«
5. è¦ä»¶ã«å¿œã˜ãŸåŸºæœ¬æ©Ÿèƒ½

ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã¯ä»¥ä¸‹ã®JSONå½¢å¼ã§è¿”ã—ã¦ãã ã•ã„:
{{
  "files": [
    {{
      "path": "ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹",
      "content": "ãƒ•ã‚¡ã‚¤ãƒ«å†…å®¹"
    }}
  ],
  "summary": "å®Ÿè£…å†…å®¹ã®èª¬æ˜"
}}
"""
          
          data = {
              "model": "claude-3-sonnet-20240229",
              "max_tokens": 4000,
              "messages": [
                  {"role": "user", "content": prompt}
              ]
          }
          
          try:
              response = requests.post(
                  "https://api.anthropic.com/v1/messages",
                  headers=headers,
                  json=data,
                  timeout=30
              )
              
              if response.status_code == 200:
                  result = response.json()
                  content = result["content"][0]["text"]
                  print("Claude response received successfully")
                  
                  # JSONãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’ãƒ‘ãƒ¼ã‚¹
                  import re
                  json_match = re.search(r'\{.*\}', content, re.DOTALL)
                  if json_match:
                      project_data = json.loads(json_match.group())
                      
                      # ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆ
                      for file_info in project_data.get("files", []):
                          file_path = file_info["path"]
                          file_content = file_info["content"]
                          
                          # ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ä½œæˆ
                          import os
                          os.makedirs(os.path.dirname(file_path) if os.path.dirname(file_path) else ".", exist_ok=True)
                          
                          # ãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ›¸ãè¾¼ã¿
                          with open(file_path, "w", encoding="utf-8") as f:
                              f.write(file_content)
                      
                      print(f"Generated {len(project_data.get('files', []))} files")
                      summary = project_data.get('summary', 'Project generated successfully')
                      print(f"Summary: {summary}")
                      
                      # ã‚µãƒãƒªãƒ¼ã‚’ãƒ•ã‚¡ã‚¤ãƒ«ã«ä¿å­˜
                      with open("generation_summary.txt", "w", encoding="utf-8") as f:
                          f.write(summary)
                  else:
                      print("Could not parse JSON from Claude response")
                      print(f"Raw response: {content}")
                      with open("generation_summary.txt", "w") as f:
                          f.write("Project structure created, but could not parse detailed response")
              else:
                  print(f"API Error: {response.status_code} - {response.text}")
                  with open("generation_summary.txt", "w") as f:
                      f.write(f"API Error: {response.status_code}")
          except Exception as e:
              print(f"Error calling Claude API: {e}")
              with open("generation_summary.txt", "w") as f:
                  f.write(f"Error: {e}")
          EOF
          
          python generate_project.py

      - name: Commit changes
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add .
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "feat: initialize ${{ github.event.inputs.project_type }} project with ${{ github.event.inputs.tech_stack }}"
            git push origin main
          fi

      - name: Create Pull Request
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          if git diff HEAD~1 --quiet; then
            echo "No changes, skipping PR creation"
          else
            git checkout -b develop-${{ github.run_id }} || git checkout develop-${{ github.run_id }}
            git push origin develop-${{ github.run_id }}
            
            SUMMARY="$(cat generation_summary.txt 2>/dev/null || echo 'Project generated successfully')"
            
            gh pr create --title "ğŸš€ Initial project setup: ${{ github.event.inputs.project_type }}" --body "## ğŸ‰ ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆåˆæœŸåŒ–å®Œäº†

**ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚¿ã‚¤ãƒ—**: ${{ github.event.inputs.project_type }}
**æŠ€è¡“ã‚¹ã‚¿ãƒƒã‚¯**: ${{ github.event.inputs.tech_stack }}
**è¦æ±‚è€…**: <@${{ github.event.inputs.slack_user }}>

### ğŸ“‹ è¦ä»¶
${{ github.event.inputs.requirements }}

### ğŸ—ï¸ å®Ÿè£…å†…å®¹
$SUMMARY

---
*ã“ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã¯Claude APIã«ã‚ˆã£ã¦è‡ªå‹•ç”Ÿæˆã•ã‚Œã¾ã—ãŸã€‚*" --base main || echo "PR creation failed or already exists"
          fi

      - name: Notify Slack
        if: always()
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        run: |
          if [ "${{ job.status }}" = "success" ]; then
            MESSAGE="ğŸ‰ ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆç”ŸæˆãŒå®Œäº†ã—ã¾ã—ãŸï¼"
            COLOR="good"
          else
            MESSAGE="âŒ ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆç”Ÿæˆã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ"
            COLOR="danger"
          fi
          
          SUMMARY="$(cat generation_summary.txt 2>/dev/null || echo 'Project generated')"
          REPO_URL="https://github.com/${{ github.repository }}"
          
          curl -X POST "$SLACK_WEBHOOK_URL" -H 'Content-type: application/json' --data "{
            \"text\": \"$MESSAGE\",
            \"attachments\": [{
              \"color\": \"$COLOR\",
              \"fields\": [
                {\"title\": \"ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ\", \"value\": \"${{ github.repository }}\", \"short\": true},
                {\"title\": \"ã‚¿ã‚¤ãƒ—\", \"value\": \"${{ github.event.inputs.project_type }}\", \"short\": true},
                {\"title\": \"æŠ€è¡“ã‚¹ã‚¿ãƒƒã‚¯\", \"value\": \"${{ github.event.inputs.tech_stack }}\", \"short\": true},
                {\"title\": \"å®Ÿè£…å†…å®¹\", \"value\": \"$SUMMARY\", \"short\": false}
              ],
              \"actions\": [
                {\"type\": \"button\", \"text\": \"ãƒªãƒã‚¸ãƒˆãƒªã‚’ç¢ºèª\", \"url\": \"$REPO_URL\"}
              ]
            }]
          }" || echo "Slack notification failed"
